#####################################################################
#   Settings
#####################################################################
#  GET_CONFIG
#  SET_CONFIG
#  _CONFIG
[gcode_macro GET_CONFIG]
gcode:
    {% set name = params.NAME|string %}

    {% set CFG = printer["gcode_macro _CONFIG"] %}

    _LOG NAME="settings.GET_CONFIG" MSG="{name}: '{CFG[name]}'"

[gcode_macro SET_CONFIG]
gcode:
    {% set name = params.NAME|string %}
    {% set to = params.TO %}

    {% set CFG = printer["gcode_macro _CONFIG"] %}
    SET_GCODE_VARIABLE MACRO=_CONFIG VARIABLE={name} VALUE={to}
    {% set CFG = printer["gcode_macro _CONFIG"] %}
    _LOG NAME="settings.SET_CONFIG" MSG="Set {name} to '{CFG[name]}'"

[gcode_macro _CONFIG]
# ----- General Settings ----- #
variable_printer_speed     : 450
variable_printer_speed_z   : 30
variable_printer_accel     : 5000
variable_printer_accel_z   : 300
variable_printer_decel     : 2500
variable_printer_scv       : 5

variable_printer_temp_cool : 55
variable_printer_temp_idle : 65

# ----- Print Settings ----- #
variable_print_bed_mesh      : True
variable_print_surface       : 'TEXTURED'
variable_print_filament      : 'ABS','POLYMAKER','BLACK'
variable_print_nozzle        : 0.4
variable_print_bed_clear     : True
variable_print_unload_at_end : True

# ----- ERCF Settings ----- #
variable_ercf_enabled           : True
variable_ercf_gates             : 6
variable_mmu_state_gate_brand  : ['POLYMAKER','POLYMAKER','POLYMAKER','POLYMAKER','POLYMAKER','POLYMAKER']

# ----- Homing ----- #
variable_home_probe_x          :  150 ; X coordinate for z home
variable_home_probe_y          :  150 ; Y coordinate for z home
variable_home_probe_speed      :  100 ; z home speed
variable_home_probe_hop        :   10 ; z home park height
variable_home_probe_hop_speed  :  600 ; z home park speed
variable_home_bounce_enabled   : True
variable_home_bounce_distance  :   20
variable_home_bounce_speed     :   40 ; x/y bounce speed
variable_home_safety_hop       :   10 ; x/y z hop
variable_home_safety_hop_speed :   10 ; x/y z hop speed
variable_home_accel            : 6000 ; x/y home acceleration
variable_home_wait             : 1000 ; x/y home wait (for StallGuard to clear)
variable_home_x_current        : .5   ; x stepper current
variable_home_y_current        : .5   ; y stepper current

# ----- Retraction ----- #
variable_retract_enabled  : True # Firmware retraction
variable_retract_length   :   1
variable_unretract_length :   1
variable_retract_speed    :  30
variable_unretract_speed  :  30

variable_retract_pause    :  20
variable_retract_resume   :  20
variable_retract_cancel   :   5
variable_retract_end      :  40
variable_unretract_start  :  40

# ----- Filament ----- #
variable_filament_sensor_enabled : True
variable_filament_sensor         : 'filament_motion_sensor SFS'
variable_filament_preload        :  5 # Load extra 5mm to be safe
variable_filament_load_extruder  : 38 # extruder gears to park position
variable_filament_load_hotend    : 60 # park position to melting pool
variable_filament_load_purge     : 40 # Extrude 20mm extra of filament

variable_filament_preunload      :  5 # purge extra 5mm
variable_filament_unload_hotend  : 20 # nozzle tip to melting pool
variable_filament_unload_park    : 60 # top of nozzle to parking position
variable_filament_unload_extruder: 42 # park position to extruder gears
variable_filament_unload_eject   : 20 # Unload extra 20mm to be safe
variable_filament_wait           :  2

# ----- Mesh ----- #
variable_mesh_debug    : True
variable_mesh_margin   : 0
variable_mesh_fuzz     : 3
variable_mesh_min_area : 2600

# ----- Purge ----- #
variable_purge_margin   :    10   # Distance the purge will be in front of the print area, default is 10.
variable_purge_height   :     0.4 # Z position of nozzle during purge, default is 0.8.
variable_purge_amount   :    40   # Amount of filament to purge
variable_purge_rate     :    12   # Flow rate of purge in mm3/s
variable_purge_prime    :     5   # Prime nozzle before purge by this amount
variable_purge_speed_xy : 10000   # Purge travel xy movement speed
variable_purge_speed_z  :  2000   # Purge travel z movement speed

# ----- Wipe ----- #
variable_wipe_left     :   50
variable_wipe_right    :  100
variable_wipe_y        :  310
variable_wipe_z        :    4.5
variable_wipe_z_hop    :   10
variable_wipe_speed_xy : 8000
variable_wipe_speed_z  : 2000
variable_wipe_shake_z  :    4

# ----- Bucket ----- #
variable_bucket_left  :    0
variable_bucket_right :  120
variable_bucket_y     :  310
variable_bucket_z     :   10
variable_bucket_width :   67

# ----- NEVERMORE ----- #
variable_nevermore               : 'fan_generic nevermore'
variable_nevermore_fan            : 'nevermore'
variable_nevermore_replace_in    : 50
variable_nevermore_replacement   : 'M117 Replace NEVERMORE carbon'
variable_nevermore_time          : -1 # Placeholder

# ----- BED FANS ----- #
variable_bed_fan                     : 'bed_fans'
variable_bed_threshold               : 60    # If bed temp target is above this threshold, fans will be enabled. If temp is set to below this threshold, fans will be disabled.
variable_bed_heat                    : 0.2   # Fan speed while bed is heating
variable_bed_slow                    : 0.4
variable_bed_fast                    : 0.6   # Fan speed once bed temp is reached
variable_bed_full                    : 1.0

# ----- Build surface settings ----- #
variable_surfaces: {
        'SCRAPE':       {'Height': 0.350},
        'PEI_SMOOTH':   {'Height': 0.450},
        'PEI_TEXTURED': {'Height': 0.350},
        'G10':          {'Height': 0.450},
    }
# ----- Filament settings ----- #
variable_filaments: {
        'ABS': {
            'POLYMAKER': {
                'PA':             0.055,
                'Retract':        1,
                'RetractSpeed':  30,
            },
            'HATCHBOX': {
                'PA':             0.055,
                'Retract':        1,
                'RetractSpeed':  30,
            },
        },
        'ASA': {},
        'PETG': {
            'POLYMAKER': {
                'PA':             0.075,
                'Retract':        3,
                'RetractSpeed':  40,
            },
        },
        'PLA': {},
    }

# ----- Toolhead LEDs ----- #
variable_th_led_name : "th_leds"
variable_nozzle_left_idx : "1"
variable_nozzle_right_idx : "2"
variable_colors : {
        'nozzle_left': {
            'off':       {'r': 0.00, 'g': 0.00, 'b': 0.00, 'w': 0.0},
            'on':        {'r': 1.00, 'g': 1.00, 'b': 1.00, 'w': 1.0},
            'standby':   {'r': 1.00, 'g': 0.00, 'b': 0.00, 'w': 0.5},
            'busy':      {'r': 1.00, 'g': 0.00, 'b': 0.00, 'w': 0.5},
            'ready':     {'r': 1.00, 'g': 0.00, 'b': 0.00, 'w': 0.5},
            'heating':   {'r': 1.00, 'g': 0.00, 'b': 0.00, 'w': 0.8},
            'leveling':  {'r': 0.50, 'g': 0.20, 'b': 0.00, 'w': 0.8},
            'homing':    {'r': 0.50, 'g': 0.50, 'b': 0.00, 'w': 0.8},
            'cleaning':  {'r': 0.50, 'g': 0.00, 'b': 0.50, 'w': 0.8},
            'meshing':   {'r': 0.50, 'g': 0.80, 'b': 0.00, 'w': 0.8},
            'printing':  {'r': 0.50, 'g': 0.50, 'b': 0.50, 'w': 0.5},
            'loading':   {'r': 1.00, 'g': 0.50, 'b': 0.00, 'w': 0.5},
            'unloading': {'r': 1.00, 'g': 0.00, 'b': 0.50, 'w': 0.5},
        },
        'nozzle_right': {
            'off':       {'r': 0.00, 'g': 0.00, 'b': 0.00, 'w': 0.0},
            'on':        {'r': 1.00, 'g': 1.00, 'b': 1.00, 'w': 1.0},
            'standby':   {'r': 0.00, 'g': 0.00, 'b': 1.00, 'w': 0.5},
            'busy':      {'r': 0.00, 'g': 0.00, 'b': 1.00, 'w': 0.5},
            'ready':     {'r': 0.00, 'g': 0.00, 'b': 1.00, 'w': 0.5},
            'heating':   {'r': 1.00, 'g': 0.00, 'b': 0.00, 'w': 0.8},
            'leveling':  {'r': 0.50, 'g': 0.20, 'b': 0.00, 'w': 0.8},
            'homing':    {'r': 0.50, 'g': 0.50, 'b': 0.00, 'w': 0.8},
            'cleaning':  {'r': 0.50, 'g': 0.00, 'b': 0.50, 'w': 0.8},
            'meshing':   {'r': 0.50, 'g': 0.80, 'b': 0.00, 'w': 0.8},
            'printing':  {'r': 0.50, 'g': 0.50, 'b': 0.50, 'w': 0.5},
            'loading':   {'r': 1.00, 'g': 0.50, 'b': 0.00, 'w': 0.5},
            'unloading': {'r': 1.00, 'g': 0.00, 'b': 0.50, 'w': 0.5},
        },
    }
gcode: