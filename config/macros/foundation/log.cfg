[gcode_macro _LOG]
description: Log messages
gcode:
    {% set name = params.NAME|default("log") %}
    {% set level = params.LVL|lower %}
    {% set message = params.MSG|default("") %}
    {% set display = params.DISPLAY|default(False) %}
    {% set console = params.CONSOLE|default(True) %}

    {% if 'LVL' in params %}
        {% if level == "trace" %}
            {% set level = 4 %}
            {% set prefix = "<" + name + "> " + "trace: " %}
        {% elif level == "debug" %}
            {% set level = 3 %}
            {% set prefix = "<" + name + "> " + "debug: " %}
        {% elif level == "info" %}
            {% set level = 2 %}
            {% set prefix = "<" + name + "> " + "info: " %}
        {% elif level == "warn" %}
            {% set level = 1 %}
            {% set prefix = "<" + name + "> " + "warn: " %}
        {% elif level == "error" %}
            {% set level = 0 %}
            {% set prefix = "<" + name + "> " + "error: " %}
        {% endif %}
    {% else %}
        {% set level = -1 %}
        {% set prefix =  name + ": " %}
    {% endif %}

    {% if printer["gcode_macro _CONFIG"].log_level >= level %}
        {% if display %}
            SET_DISPLAY_TEXT MSG="{name}: {message}"
            UPDATE_DELAYED_GCODE ID=clear_display DURATION=30
        {% endif %}

        {% if console %}
            {% if level == -1 %}
                RESPOND PREFIX="{name}: " MSG="{message}"
            {% elif level == 0 %}
                RESPOND TYPE=error PREFIX="{prefix}" MSG="{message}"
            {% else %}
                RESPOND TYPE=echo PREFIX="{prefix}" MSG="{message}"
            {% endif %}
        {% endif %}
    {% endif %}