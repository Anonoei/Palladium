[gcode_macro _LOG]
description: Log messages
gcode:
    {% set NAME    = params.NAME|string %}
    {% set LVL     = params.LVL|string %}
    {% set MESSAGE = params.MSG|default("")|string %}
    {% set DISPLAY = params.DISPLAY|default(False) %}
    {% set CONSOLE = params.CONSOLE|default(True) %}
    {% set NOTIFY  = params.NOTIFY|default(False) %}

    {% set CFG = printer["gcode_macro _CONFIG"] %}

    {% if 'LVL' in params %}
        {% if LVL|lower == "trace" %}
            {% set LVL = 4 %}
            {% set prefix = "[" + NAME + "] " + "trace: " %}
        {% elif LVL|lower == "debug" %}
            {% set LVL = 3 %}
            {% set prefix = "[" + NAME + "] " + "debug: " %}
        {% elif LVL|lower == "info" %}
            {% set LVL = 2 %}
            {% set prefix = "[" + NAME + "] " + "info: " %}
        {% elif LVL|lower == "warn" %}
            {% set LVL = 1 %}
            {% set prefix = "[" + NAME + "] " + "warn: " %}
        {% elif LVL|lower == "error" %}
            {% set LVL = 0 %}
            {% set prefix = "[" + NAME + "] " + "error: " %}
        {% else %}
            {% set LVL = -1 %}
            {% set prefix = NAME + ": " %}
        {% endif %}
    {% else %}
        {% set LVL = -1 %}
        {% set prefix = NAME + ": " %}
    {% endif %}

    {% if 'DISPLAY' in params %}
        {% set DISPLAY = True %}
    {% endif %}
    {% if 'CONSOLE' in params %}
        {% set CONSOLE = False %}
    {% endif %}
    {% if 'NOTIFY' in params %}
        {% set NOTIFY = True %}
    {% endif %}

    {% if 0 %}
        RESPOND MSG="Name/LVL is: '{NAME}'/'{LVL}'"
        RESPOND MSG="Prefix is: '{prefix}'"
        RESPOND MSG="MSG is: '{MESSAGE}'"
        RESPOND MSG="CONSOLE/DISPLAY is: '{CONSOLE}'/'{DISPLAY}'"
    {% endif %}

    {% if not CFG.log_enforce or (CFG.log_enforce and CFG.log_level >= LVL) %}
        {% if DISPLAY %}
            SET_DISPLAY_TEXT MSG="{NAME}: {MESSAGE}"
            UPDATE_DELAYED_GCODE ID=clear_display DURATION=30
        {% endif %}
    
        {% if CONSOLE %}
            {% if LVL == 0 %}
                RESPOND TYPE=error PREFIX="{prefix}" MSG="{MESSAGE}"
            {% else %}
                {% if NOTIFY %}
                    {% set NOTIFY = "MR_NOTIFY:" + prefix + "|" + MESSAGE %}
                    { action_respond_info(NOTIFY) }
                {% else %}
                    {% if LVL == -1 %}
                      RESPOND PREFIX="{NAME}: " MSG="{MESSAGE}"
                    {% else %}
                        RESPOND TYPE=echo PREFIX="{prefix}" MSG="{MESSAGE}"
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}

    