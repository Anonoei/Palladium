#####################################################################
#   Filament Macros
#####################################################################
# Filament Macros
#  LOAD_FILAMENT
#  UNLOAD_FILAMENT
#  CHANGE_FILAMENT
# Filament Sensor
#  FS_ENABLE
#  FS_DISABLE

# Internal Filament Macros
#  _FILAMENT_RUNOUT
#  _FILAMENT_INSERT

# -================================-
#   Filament Macros
# -================================-
[gcode_macro FILAMENT_LOAD]
description: Load filament
gcode:
    {% set t = params.TEMP|default(235)|int %}
    {% set CFG = printer["gcode_macro _CONFIG"] %}

    SAVE_GCODE_STATE NAME=LOAD_FILAMENT
    _LOG NAME="Filament.LOAD" MSG="Loading filament. Heating extruder to {t}C" DISPLAY=TRUE
    M109 S{t} T0                          ; set hotend temperature and wait
    _STATUS_LOADING
    _EXTRUDE_RELATIVE
    G92 E0                                ; zero extruder
    G0 E{CFG.filament_preload|int}       F300  ; ensure extruder has grip on filament
    G0 E{CFG.filament_load_extruder|int} F300  ; load filament to park position
    _PAUSE T={CFG.filament_wait * 1000}        ; wait for _ seconds
    G0 E{CFG.filament_load_hotend|int}   F300  ; load filament to melting pool
    G0 E{CFG.filament_load_purge}        F300  ; purge filament
    _CLEAR_BUFFER
    # if not printing or paused due to filament change set the extruder temp to 0
    {% if (printer.print_stats.state != "printing") and (printer.print_stats.state != "paused") %}
       {% if "xyz" in printer.toolhead.homed_axes %}
            NOZZLE_WIPE
        {% endif %}
        M104 S0 T0 
    {% endif %}
    _LOG NAME="Filament.LOAD" MSG="Filament loaded!" DISPLAY=TRUE
    _PLAY_FILAMENT_LOAD
    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT

[gcode_macro FILAMENT_UNLOAD]
description: Unload filament
gcode:
    {% set t = params.TEMP|default(235)|int %}
    {% set CFG = printer["gcode_macro _CONFIG"] %}
    
    SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT
    _LOG NAME="Filament.UNLOAD" MSG="Unloading filament..." DISPLAY=TRUE
    M109 S{t} T0                          ; set hotend temperature and wait
    _STAUTS_UNLOADING
    _EXTRUDE_RELATIVE
    G92 E0                                ; zero extruder

    G0 E{CFG.filament_preunload}        F600  ; purge filament to get proper tip position
    G0 E-{CFG.filament_unload_hotend}   F300  ; load filament tip to melting pool
    M109 S{t - 20}
    _PAUSE T={CFG.filament_wait * 1000}       ; wait for _ seconds
    G0 E-{CFG.filament_unload_park}     F300  ; unload filament to park position
    G0 E-{CFG.filament_unload_extruder} F600  ; unload filament from extruder gears
    G0 E-{CFG.filament_unload_eject}    F600  ; unload until filament is ejected
    G0 E-{CFG.filament_unload_eject}    F600  ; unload until filament is ejected
    _CLEAR_BUFFER
    # if not printing or paused due to filament change set the extruder temp to 0
    {% if (printer.print_stats.state != "printing") and (printer.print_stats.state != "paused") %}
        {% if "xyz" in printer.toolhead.homed_axes %}
            NOZZLE_WIPE
        {% endif %}
        M104 S0 T0 
    {% endif %}
    _LOG NAME="Filament.UNLOAD" MSG="Filament unloaded!" DISPLAY=TRUE
    _PLAY_FILAMENT_UNLOAD
    RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT
    SET_FILAMENT MATERIAL="NONE"

[gcode_macro FILAMENT_CHANGE]
description: Change filament
gcode:
    {% set t = params.TEMP|default(235)|int %}
    {% set w = printer["gcode_macro _CONFIG"].filament_wait|int %}
    PARK_FRONT

    FILAMENT_UNLOAD TEMP={t}
    _LOG NAME="Filament.CHANGE" MSG="Waiting {w} seconds..." DISPLAY=TRUE
    _PAUSE T={w * 1000}                        ; wait for {w} seconds
    FILAMENT_LOAD TEMP={t}

[gcode_macro FILAMENT_FORM_TIP]
description: Form filament tip
variable_filament_tip_ramming: True
gcode:
    EXTRUDE_RELATIVE
    G92 E0

    SET_PRESSURE_ADVANCE ADVANCE=0
    {% set PREV_TEMP = printer.extruder.target %}
    {% if RAMMING %}
        {% set RATIO = (RAMMING_VOLUME|float) /23.0 %}
        G1 E{0.5784 * RATIO|float} F299 #7
        G1 E{0.5834 * RATIO|float} F302 #3
        G1 E{0.5918 * RATIO|float} F306 #6
        G1 E{0.6169 * RATIO|float} F319 #6
        G1 E{0.3393 * RATIO|float} F350 #0
        G1 E{0.3363 * RATIO|float} F350 #0
        G1 E{0.7577 * RATIO|float} F392 #6
        G1 E{0.8382 * RATIO|float} F434 #3
        G1 E{0.7776 * RATIO|float} F469 #9
        G1 E{0.1293 * RATIO|float} F469 #9
        G1 E{0.9673 * RATIO|float} F501 #2
        G1 E{1.0176 * RATIO|float} F527 #2
        G1 E{0.5956 * RATIO|float} F544 #6
        G1 E{0.4555 * RATIO|float} F544 #6
        G1 E{1.0662 * RATIO|float} F552 #4
    {% endif %}

    # Set toolchange temperature just prior to filament being extracted from melt zone and wait for set point
    # Only used if changing between filament types eg. ABS-->PLA
    {% if TOOLCHANGE_TEMP|float > 0 and USE_FAST_SKINNYDIP|int == 0 %}
         M109 S{TOOLCHANGE_TEMP}
    {% endif %}

    # Unloading - This is where the tip spear shape comes from Faster=longer/pointer/higher stringing
    {% set TOTAL_RETRACTION_DISTANCE = COOLING_TUBE_POSITION|float + COOLING_TUBE_LENGTH|float / 2 - 15 %}
    G1 E-15 F{1.0 * UNLOADING_SPEED_START|float * 60} # Default value from SS - Cannot modify
    G1 E-{0.7 * TOTAL_RETRACTION_DISTANCE} F{1.0 * UNLOADING_SPEED|float * 60}
    G1 E-{0.2 * TOTAL_RETRACTION_DISTANCE} F{0.5 * UNLOADING_SPEED|float * 60}
    G1 E-{0.1 * TOTAL_RETRACTION_DISTANCE} F{0.3 * UNLOADING_SPEED|float * 60}

    {% if TOOLCHANGE_TEMP|float > 0 and USE_FAST_SKINNYDIP|int == 1 %}
        M104 S{TOOLCHANGE_TEMP}
    {% endif %}

    # Generate Cooling Moves - Solidifies tip shape and helps break strings if formed
    {% set SPEED_INC = (FINAL_COOLING_SPEED|float - INITIAL_COOLING_SPEED|float) / (2 * COOLING_MOVES|float - 1) %}
    {% for move in range(COOLING_MOVES|int) %}
        G1 E{COOLING_TUBE_LENGTH} F{(INITIAL_COOLING_SPEED|float + SPEED_INC*move*2) * 60}
        G1 E-{COOLING_TUBE_LENGTH} F{(INITIAL_COOLING_SPEED|float + SPEED_INC*(move*2+1)) * 60}
    {% endfor %}

    # Wait for extruder to reach toolchange temperature after cooling moves complete (SKINNYDIP--fast mode only)
    {% if TOOLCHANGE_TEMP|float > 0 and USE_FAST_SKINNYDIP|int == 1 %}
        M109 S{TOOLCHANGE_TEMP}
    {% endif %}

    # Skinny dip Move - burns off VERY FINE hairs
    {% if USE_SKINNYDIP|int == 1 %}
        G1 E{SKINNYDIP_DISTANCE} F{DIP_INSERTION_SPEED|float * 60}
        G4 P{MELT_ZONE_PAUSE}
        G1 E-{SKINNYDIP_DISTANCE} F{DIP_EXTRACTION_SPEED|float * 60}
        G4 P{COOLING_ZONE_PAUSE}
    {% endif %}

    {% if TOOLCHANGE_TEMP|float > 0 %}
        M104 S{OLD_TEMP}
    {% endif %}

    # Park filament
    # TODO: park filament after cooling/skinny dip. Maths to determine distance of previous moves to final parking distance
  
    # Eject once all shaping is done - Standalone mode only
    {% if FINAL_EJECT|int == 1 %}
        G92 E0
        G1 E-80 F3000
    {% endif %}
    EXTRUDE_ABSOLUTE

# -================================-
#   Filament Sensor Macros
# -================================-

[gcode_macro FS_ENABLE] ; Add this to PRINT_START
description: Enable filament sensor
gcode:
    _LOG NAME="Filament.FS_ENABLE" MSG="Filament sensor enabled"
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=SFS ENABLE=1

[gcode_macro FS_DISABLE] ; Add this to PRINT_END and PRINT_CANCEL
description: Disable filament sensor 
gcode:
    _LOG NAME="Filament.FS_DISABLE" MSG="Filament sensor disabled"
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=SFS ENABLE=0

# -================================-
#   Internal Filament Macros
# -================================-
[gcode_macro _FILAMENT_INSERT]
description: Alert on filament insertion
gcode:
    _LOG NAME="Filament._FILAMENT_INSERT" MSG="Filament inserted!" DISPLAY=TRUE
    #_PLAY_FILAMENT_DETECTED

[gcode_macro _FILAMENT_RUNOUT]
description: Alert on filament runout
gcode:
    OFF_IN T={60 * 12} ; Set off timer to 12 hours
    _LOG NAME="Filament._FILAMENT_RUNOUT" MSG="Filament runout detected!" DISPLAY=TRUE
    #_PLAY_FILAMENT_RUNOUT
